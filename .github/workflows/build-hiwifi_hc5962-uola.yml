#=================================================
# https://github.com/danxiaonuo/AutoBuild-Uola
# Description: Build OpenWrt using GitHub Actions
# Lisence: MIT
# Author: danxiaonuo
# Blog: https://www.danxiaonuo.com
#=================================================

# ç¼–è¯‘çš„åç§°
name: ç¼–è¯‘Hiwifi_Hc5962 Uolaå›ºä»¶

# è®¾ç½®è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      name:
        description: 'build-uola'
        required: true
        default: 'ç¼–è¯‘Hiwifi_Hc5962 Uolaå›ºä»¶'
  # å®šæ—¶è§¦å‘ç¼–è¯‘(æ¯å¤©æ—©5ç‚¹)
  #schedule:
  #  - cron: 0 21 * * 3
  # ç‚¹èµâ˜†Starè§¦å‘ç¼–è¯‘
  #watch:
  #   types: [started]

# ä»»åŠ¡é›†
jobs:
  uola:
    # é€‰æ‹©è™šæ‹Ÿç¯å¢ƒ
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    
    # ç¼–è¯‘ç‰ˆæœ¬é€‰æ‹©
    name: ç¼–è¯‘ ${{matrix.devices}} ${{matrix.target}} å›ºä»¶
    strategy:
      fail-fast: false
      matrix:
        target: [uola]
        devices: [hiwifi_hc5962]
    
    # è¿è¡Œæ­¥éª¤
    steps:
    
    # æ£€å‡ºå„ä¸ªä»£ç æ¨¡å—
    - name: æ£€å‡ºå„ä¸ªä»£ç æ¨¡å—
      uses: actions/checkout@v2
    
    # åŠ è½½é…ç½®æ–‡ä»¶    
    - name: åŠ è½½ Settings.ini
      run: | 
        source "${GITHUB_WORKSPACE}/os/${{matrix.target}}/${{matrix.devices}}/uola.ini"
        echo "matrix_target=${{matrix.target}}" >> $GITHUB_ENV
        echo "matrix_devices=${{matrix.devices}}" >> $GITHUB_ENV
        echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
        echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
        echo "TZ=${TZ}" >> $GITHUB_ENV
        echo "GITHUB_USER_NAME=${GITHUB_USER_NAME}" >> $GITHUB_ENV
        echo "GITHUB_USER_EMAIL=${GITHUB_USER_EMAIL}" >> $GITHUB_ENV
        echo "GITHUB_RROJECT=${GITHUB_RROJECT}" >> $GITHUB_ENV
        echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
        echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
        echo "DIY_SH=${DIY_SH}" >> $GITHUB_ENV
        echo "SSH_ACTIONS=${SSH_ACTIONS}" >> $GITHUB_ENV
        echo "UPLOAD_BIN_DIR=${UPLOAD_BIN_DIR}" >> $GITHUB_ENV
        echo "UPLOAD_FIRMWARE=${UPLOAD_FIRMWARE}" >> $GITHUB_ENV
        echo "UPLOAD_COWTRANSFER=${UPLOAD_COWTRANSFER}" >> $GITHUB_ENV
        echo "UPLOAD_WETRANSFER=${UPLOAD_WETRANSFER}" >> $GITHUB_ENV
        echo "UPLOAD_BRANCH=${UPLOAD_BRANCH}" >> $GITHUB_ENV
        echo "UPLOAD_BRANCH=${UPLOAD_BRANCH}" >> $GITHUB_ENV
        echo "CREATE_RELEASE=${CREATE_RELEASE}" >> $GITHUB_ENV
        echo "BUILD_USER=${BUILD_USER}" >> $GITHUB_ENV
        echo "SEND_WECHAT_MSG=${SEND_WECHAT_MSG}" >> $GITHUB_ENV
        echo "GITHUB_PATH=${GITHUB_PATH}" >> $GITHUB_ENV
        echo "GITHUB_RELEASE=${GITHUB_RELEASE}" >> $GITHUB_ENV
        
    # åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
    - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E docker rmi -f $(docker images -q)
        sudo -E rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qqy purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* android*
        sudo -E apt-get update -qqy && sudo -E apt-get upgrade -qqy
        sudo -E apt-get install -qqy git sudo wget curl zsh vim nano tmux tree htop screen rsync gnupg ca-certificates uuid-runtime tzdata openssh-server lrzsz xz-utils
        sudo -E apt-get install -qqy $(curl -fsSL git.io/depends-ubuntu-2004) tree
        sudo -E apt-get -qqy autoremove --purge
        sudo -E apt-get -qqy clean
        sudo -E timedatectl set-timezone "$TZ" 
        
    # å…‹éš†æºç 
    - name: å…‹éš†æºç 
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH uola
        cd uola
        echo "UOLAROOT=$PWD" >> $GITHUB_ENV
        echo "::set-output name=UOLAROOT::$(echo $PWD)"
        echo "useVersionInfo=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¥æœŸ: %cd<br/>Commit: %s")" >> $GITHUB_ENV
        echo "DATE=$(TZ=CST-8 date "+%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†%Sç§’")" >> $GITHUB_ENV
        echo "RELEASE_DATE=$(TZ=CST-8 date "+%Y%m%d%H%M%S")" >> $GITHUB_ENV
    
    # æ›´æ–°æº
    - name: æ›´æ–°æº
      working-directory: ./uola
      run:  |
        ./scripts/feeds clean
        ./scripts/feeds update -a
       
    # å®‰è£…æº
    - name: å®‰è£…æº
      working-directory: ./uola
      run:  |
        ./scripts/feeds install -a
    
    # åŠ è½½è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
      run: |
        [ -e files ] && mv files $UOLAROOT/files
        [ -e ${GITHUB_WORKSPACE}/os/${{matrix.target}}/${{matrix.devices}}/$CONFIG_FILE ] && mv ${GITHUB_WORKSPACE}/os/${{matrix.target}}/${{matrix.devices}}/$CONFIG_FILE $UOLAROOT/.config
        
    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
      working-directory: ./uola
      run: | 
        make defconfig
    
    # ä¸‹è½½å›ºä»¶åŒ…
    - name: ä¸‹è½½å›ºä»¶åŒ…
      working-directory: ./uola
      id: package
      run: |
        make -j$(($(nproc)+1)) download v=s
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \; 
           
    # ç¼–è¯‘å›ºä»¶
    - name: ç¼–è¯‘å›ºä»¶
      working-directory: ./uola
      id: compile
      run: |
        cd $UOLAROOT
        echo -e "$(($(nproc)+1)) thread compile"
        make tools/compile -j$(($(nproc)+1)) || make tools/compile -j1 V=s
        make toolchain/compile -j$(($(nproc)+1)) || make toolchain/compile -j1 V=s
        make target/compile -j$(($(nproc)+1)) || make target/compile -j1 V=s IGNORE_ERRORS=1
        make diffconfig
        make package/compile -j$(($(nproc)+1)) IGNORE_ERRORS=1 || make package/compile -j1 V=s IGNORE_ERRORS=1
        make package/index
        echo "::set-output name=status::success"
        
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    - name: è®¾ç½®ç¯å¢ƒå˜é‡
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $UOLAROOT/bin/packages/*
        PLATFORM=$(basename `pwd`)
        echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV
        echo "::set-output name=PLATFORM::$(echo $PLATFORM)"
        cd $UOLAROOT/bin/targets/*
        TARGET=$(basename `pwd`)
        echo "TARGET=$TARGET" >> $GITHUB_ENV
        echo "::set-output name=TARGET::$(echo $TARGET)"
        cd *
        SUBTARGET=$(basename `pwd`)
        echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
        echo "::set-output name=SUBTARGET::$(echo $SUBTARGET)"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "::set-output name=FIRMWARE::$(echo $PWD)"
        
    # è·å–å›ºä»¶
    - name: è·å–å›ºä»¶
      working-directory: ./uola
      if: steps.compile.outputs.status == 'success'
      id: generate
      run: |
        make package/install -j$(($(nproc)+1)) || make package/install -j1 V=s
        make target/install -j$(($(nproc)+1)) || make target/install -j1 V=s
        make checksum
        echo "::set-output name=GENERATE_STATUS::success"
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=$(cat DEVICE_NAME)" >> $GITHUB_ENV
    
    # ä¸Šä¼ åˆ°åˆ†æ”¯
    - name: ä¸Šä¼ åˆ°åˆ†æ”¯
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BRANCH == 'true' && !cancelled() 
      env:
          GITHUB_TOKEN: ${{ secrets.UOLA_TOKEN }}
      run: |
          cd $UOLAROOT/bin
          git init
          git config user.name $GITHUB_USER_NAME
          git config user.email $GITHUB_USER_EMAIL
          git add .
          git commit -m "Update Uola"
          git push --force --quiet https://${{ env.GITHUB_TOKEN }}@$GITHUB_RROJECT HEAD:$BRANCH
      
    # å‡†å¤‡æ–‡ä»¶
    - name: å‡†å¤‡æ–‡ä»¶
      run: |
          sudo mkdir -p -m 777 $UOLAROOT/artifact/firmware && cd $UOLAROOT/artifact/firmware
          echo "ARTIFACT_FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "::set-output name=ARTIFACT_FIRMWARE::$(echo $PWD)"
          sudo mkdir -p -m 777 $UOLAROOT/artifact/package && cd $UOLAROOT/artifact/package
          echo "ARTIFACT_PACKAGE=$PWD" >> $GITHUB_ENV
          echo "::set-output name=ARTIFACT_PACKAGE::$(echo $PWD)"
          sudo mkdir -p -m 777 $UOLAROOT/artifact/buildinfo && cd $UOLAROOT/artifact/buildinfo
          echo "ARTIFACT_BUILDINFO=$PWD" >> $GITHUB_ENV
          echo "::set-output name=ARTIFACT_BUILDINFO::$(echo $PWD)"
          
    # æ•´ç†æ–‡ä»¶
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd $UOLAROOT && sudo -E cat .config > $ARTIFACT_BUILDINFO/config.info
        rm -rf $(find $UOLAROOT/bin/targets/ -type d -name "packages")
        cp -rf $(find $UOLAROOT/bin/targets/ -type f) $ARTIFACT_FIRMWARE
        cp -rf $(find $UOLAROOT/bin/packages/ -type f -name "*.ipk") $ARTIFACT_PACKAGE
        cp -rf $(find $UOLAROOT/bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") $ARTIFACT_BUILDINFO
        echo "::set-output name=status::success" 
    
    - name: ç¼–è¯‘ & ä¸Šä¼  Docker Image è‡³ Dockerhub
      run: |
          cd ${FIRMWARE}
          docker import openwrt-$TARGET-$SUBTARGET-$DEVICE_NAME-rootfs.tar.gz danxiaonuo/uola:${{matrix.devices}}
          docker login -u danxiaonuo -p ${{ secrets.DOCKER_HUB_PWD }}
          docker push danxiaonuo/uola:${{matrix.devices}}
    
    - name: ä¸Šä¼  Docker Image è‡³ Aliyun Docker Registry
      run: |
          docker login -u ${{ secrets.ALIYUN_USERNAME }} -p ${{ secrets.ALIYUN_PWD }} registry.cn-hongkong.aliyuncs.com
          docker tag danxiaonuo/uola:${{matrix.devices}} registry.cn-hongkong.aliyuncs.com/danxiaonuo/uola:${{matrix.devices}}
          docker push registry.cn-hongkong.aliyuncs.com/danxiaonuo/uola:${{matrix.devices}}
          
    # ç”Ÿæˆæ ‡ç­¾
    - name: ç”Ÿæˆæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && env.CREATE_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=${{ env.BRANCH }}-${{ env.RELEASE_DATE }}" >> $GITHUB_ENV
        echo "::set-output name=status::success"
    
    # ä¸Šä¼ å›ºä»¶ä¿¡æ¯
    - name: ä¸Šä¼ å›ºä»¶ä¿¡æ¯
      uses: actions/upload-artifact@v2
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
          name: Uola_buildinfo
          path: ${{ env.ARTIFACT_BUILDINFO }}

    # ä¸Šä¼ å›ºä»¶åŒ…æ–‡ä»¶
    - name: ä¸Šä¼ å›ºä»¶åŒ…æ–‡ä»¶
      uses: actions/upload-artifact@v2
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: Uola_package
        path: ${{ env.ARTIFACT_PACKAGE }}
    
    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v2
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: Uola_firmware
        path: ${{ env.FIRMWARE }}
    
    # ä¸Šä¼ å›ºä»¶åˆ°å¥¶ç‰›å¿«ä¼ 
    #- name: ä¸Šä¼ å›ºä»¶åˆ°å¥¶ç‰›å¿«ä¼ 
    #  id: cowtransfer
    #  if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
    #  run: |
    #    curl -fsSL git.io/file-transfer | sh
    #    ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
    #    echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
    #    echo "COWTRANSFER_URL=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV 
    #    echo "::set-output name=COWTRANSFER_URL::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
    
    # ä¸Šä¼ å›ºä»¶åˆ°WeTransfer
    - name: ä¸Šä¼ å›ºä»¶åˆ°WeTransfer
      id: wetransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "WETRANSFER_URL=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV 
        echo "::set-output name=WETRANSFER_URL::$(cat wetransfer.log | grep https | cut -f3 -d" ")"
    
    # å‘è¡Œå›ºä»¶
    - name: å‘è¡Œå›ºä»¶
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.UOLA_TOKEN }}
      with:
        name: è‡ªåŠ¨ç¼–è¯‘ / ${{ env.RELEASE_TAG }}
        tag_name: ${{ env.RELEASE_TAG }}
        body: |            
            1ã€æœ¬å›ºä»¶ä¸ºè‡ªåŠ¨ç¼–è¯‘
            2ã€å‘è¡Œç‰ˆä¸­åªæä¾›å®Œæ•´çš„å›ºä»¶
            3ã€éœ€è¦å•ç‹¬IPKè¯·åˆ°åˆ†æ”¯ä¸‹è½½
            4ã€æºç ï¼š${{ env.REPO_URL }}
            -- Build by ${{ env.BUILD_USER }} @ with Github Action on ${{ env.RELEASE_TAG }}
            ğŸš€ Auto build | è‡ªåŠ¨ç¼–è¯‘
            ğŸ”— [Cowtransfer | å¥¶ç‰›å¿«ä¼ ](${{ steps.cowtransfer.outputs.COWTRANSFER_URL }}) 
            ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.WETRANSFER_URL }})       
            å½“å‰ä½¿ç”¨ç‰ˆæœ¬:            
            ${{ env.useVersionInfo }}
            ${{ github.event.commits[0].message }}
        files: ${{ env.ARTIFACT_FIRMWARE }}/*

    # å¾®ä¿¡é€šçŸ¥
    - name: å¾®ä¿¡é€šçŸ¥
      if: steps.compile.outputs.status == 'success' && env.SEND_WECHAT_MSG == 'true' && !cancelled()
      uses: emon100/Action-Serverchan@master
      with:
        SCKEY: ${{ secrets.SCKEY }}
        text: ${{ env.BRANCH }} å›ºä»¶ç¼–è¯‘å®Œæˆï¼
        desp: å›ºä»¶åç§°:${{ env.BRANCH }} å›ºä»¶åœ°å€:${{ env.GITHUB_RELEASE }}/tag/${{ env.RELEASE_TAG }}
    
    - name: åˆ é™¤æ—§çš„GitHub-workflow
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 1    #ä¿ç•™å¤šå°‘ä¸ªworkflowä¸åˆ é™¤

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.2.0
      with:
        keep_latest: 3         #ä¿ç•™å¤šå°‘ä¸ªreleasesä¸åˆ é™¤
        delete_tags: true
      env:
          GITHUB_TOKEN: ${{ secrets.UOLA_TOKEN }}
